<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é—®ç­” - åŒ—äº¬ç•œç‰§å…½åŒ»ç ”ç©¶æ‰€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { font-family: 'Inter', 'Noto Sans SC', sans-serif; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }
        
        .animate-flicker { animation: flicker 1.5s ease-in-out infinite; }
        .animate-slide-in { animation: slideInRight 0.5s ease-out; }
        .animate-typewriter {
            overflow: hidden;
            white-space: nowrap;
            animation: typewriter 2s steps(30) forwards;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .chat-bubble {
            position: relative;
            max-width: 80%;
        }
        
        .chat-bubble.user {
            background: linear-gradient(135deg, #3b82f6 0%, #0ea5e9 100%);
            color: white;
        }
        
        .chat-bubble.assistant {
            background: #f1f5f9;
            color: #1e293b;
        }
        
        .agent-active {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.2);
            transform: scale(1.02);
        }
        
        .agent-selected {
            box-shadow: 0 0 0 3px #3b82f6, 0 0 0 6px rgba(59, 130, 246, 0.2);
        }
        
        .typing-dot {
            animation: typingBounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="glass fixed top-0 left-0 right-0 z-50 h-14 border-b border-slate-200">
        <div class="h-full flex items-center justify-between px-4">
            <div class="flex items-center gap-3">
                <a href="index.html" class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center">
                        <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="font-semibold text-slate-700">åŒ—äº¬ç•œç‰§å…½åŒ»ç ”ç©¶æ‰€</span>
                </a>
                <span class="text-slate-300">/</span>
                <span class="text-sm text-slate-600">æ™ºèƒ½é—®ç­”</span>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="proactiveToggle" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-50 text-blue-600 text-sm hover:bg-blue-100 transition border border-blue-200">
                    <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                    <span>è‡ªåŠ¨æ¢ç´¢æ¨¡å¼</span>
                </button>
                <button class="p-2 rounded-lg hover:bg-slate-100 transition">
                    <i data-lucide="settings" class="w-5 h-5 text-slate-400"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»ä½“å¸ƒå±€ -->
    <div class="flex h-screen pt-14">
        
        <!-- å·¦ä¾§ï¼šèŠå¤©åŒºåŸŸ -->
        <div class="flex-1 flex flex-col min-w-0 bg-white">
            
            <!-- å½“å‰AgentæŒ‡ç¤ºå™¨ -->
            <div id="currentAgentBar" class="bg-slate-50 border-b border-slate-200 px-4 py-2 flex items-center gap-2">
                <span class="text-xs text-slate-500">å½“å‰å’¨è¯¢:</span>
                <span id="currentAgentName" class="text-sm font-medium text-blue-600">ä¸ä¸€Â·é‡‡æ ·ä¸“å®¶</span>
            </div>
            
            <!-- èŠå¤©æ¶ˆæ¯åŒº -->
            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                    </div>
                    <div class="chat-bubble assistant rounded-2xl rounded-bl-sm px-4 py-3">
                        <p class="text-sm font-medium">ä½ å¥½ï¼æˆ‘æ˜¯åŒ—äº¬ç•œç‰§å…½åŒ»ç ”ç©¶æ‰€æ™ºèƒ½åŠ©æ‰‹ï¼Œä½ çš„ç–«ç—…ç›‘æµ‹åŠ©æ‰‹ã€‚</p>
                        <p class="text-sm text-slate-600 mt-2">æˆ‘å¯ä»¥å¸®ä½ ï¼š</p>
                        <ul class="text-sm text-slate-600 mt-2 space-y-1 list-disc list-inside">
                            <li>æŸ¥è¯¢å®æ—¶ç–«ç—…ç›‘æµ‹æ•°æ®</li>
                            <li>è·å–å…¨çƒäººå…½å…±æ‚£ç—…æœ€æ–°èµ„è®¯</li>
                            <li>ç”Ÿæˆè¡Œä¸šç ”æŠ¥ä¸å†³ç­–å»ºè®®</li>
                            <li>åˆ†æç›‘æµ‹ç‚¹é£é™©é¢„è­¦</li>
                        </ul>
                        <p class="text-sm text-slate-500 mt-3 bg-blue-50 p-2 rounded-lg">
                            ğŸ’¡ ç‚¹å‡»å³ä¾§Agentå¡ç‰‡åˆ‡æ¢ä¸“å®¶ï¼Œæˆ–ç›´æ¥è¾“å…¥é—®é¢˜å¼€å§‹å¯¹è¯
                        </p>
                    </div>
                </div>
            </div>

            <!-- åŠ¨æ€å†…å®¹å±•ç¤ºåŒº (è‡ªä¸»æ¢ç´¢æ¨¡å¼) -->
            <div id="proactiveDisplay" class="border-t border-slate-200 bg-slate-50 px-4 py-3 hidden">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="sparkles" class="w-4 h-4 text-blue-500"></i>
                    <span class="text-xs text-blue-600 font-medium">è‡ªåŠ¨æ¢ç´¢å‘ç°</span>
                </div>
                
                <div id="insightCards" class="relative h-28 overflow-hidden">
                    <!-- æ´å¯Ÿå¡ç‰‡ä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ -->
                </div>
            </div>

            <!-- è¾“å…¥åŒº -->
            <div class="border-t border-slate-200 p-4 bg-white">
                <div class="relative">
                    <!-- é—ªçƒæç¤ºè¯ -->
                    <div id="flickeringPrompt" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm pointer-events-none hidden">
                        <span class="animate-flicker">æ­£åœ¨åˆ†æå…¨çƒäººå…½å…±æ‚£ç—…æœ€æ–°è¶‹åŠ¿...</span>
                    </div>
                    
                    <div class="flex gap-2">
                        <button class="p-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition flex-shrink-0">
                            <i data-lucide="plus" class="w-5 h-5 text-slate-400"></i>
                        </button>
                        
                        <div class="flex-1 relative">
                            <input 
                                id="chatInput"
                                type="text" 
                                placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œæˆ–é€‰æ‹©å³ä¾§Agentä¸“å®¶..."
                                class="w-full border border-slate-200 rounded-xl px-4 py-3 pr-12 text-sm focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition"
                            >
                            <button class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-lg hover:bg-slate-100 transition">
                                <i data-lucide="mic" class="w-4 h-4 text-slate-400"></i>
                            </button>
                        </div>
                        
                        <button 
                            id="sendBtn"
                            class="p-3 rounded-xl bg-blue-600 hover:bg-blue-500 transition flex-shrink-0 shadow-md"
                        >
                            <i data-lucide="send" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center justify-between mt-2 text-xs text-slate-400">
                    <div class="flex items-center gap-4">
                        <button class="flex items-center gap-1 hover:text-slate-600 transition">
                            <i data-lucide="paperclip" class="w-3 h-3"></i>
                            <span>é™„ä»¶</span>
                        </button>
                        <button class="flex items-center gap-1 hover:text-slate-600 transition">
                            <i data-lucide="globe" class="w-3 h-3"></i>
                            <span>è”ç½‘æœç´¢</span>
                        </button>
                    </div>
                    
                    <span>æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ</span>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šAI åŠ©ç†å›¢é˜Ÿé¢æ¿ -->
        <div class="w-80 glass border-l border-slate-200 flex flex-col bg-white">
            
            <!-- é¢æ¿æ ‡é¢˜ -->
            <div class="p-4 border-b border-slate-200 bg-slate-50">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold flex items-center gap-2 text-slate-700">
                        <i data-lucide="users" class="w-4 h-4 text-blue-500"></i>
                        AI åŠ©ç†å›¢é˜Ÿ
                    </h3>
                    <span class="text-xs text-slate-500 bg-slate-200 px-2 py-1 rounded-full">4 äººåœ¨çº¿</span>
                </div>
            </div>

            <!-- åŠ©ç†åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto p-4 space-y-3">
                
                <!-- é‡‡æ ·ä¸“å®¶Â·ä¸ä¸€ -->
                <div id="agent-ding1" class="agent-card p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-blue-50 hover:border-blue-200 transition" data-agent-id="ding-yi">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center flex-shrink-0 relative shadow-md">
                            <i data-lucide="scan" class="w-5 h-5 text-white"></i>
                            <span class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h4 class="font-medium text-sm truncate">é‡‡æ ·ä¸“å®¶Â·ä¸ä¸€</h4>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">æ°”æº¶èƒ¶é‡‡æ · Â· ç¯å¢ƒåˆ†æ</p>
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded">åœ¨çº¿</span>
                                <span class="text-xs text-slate-400">ç‚¹å‡»å’¨è¯¢</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ£€æµ‹åˆ†æå¸ˆÂ·ä¸äºŒ -->
                <div id="agent-ding2" class="agent-card p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-cyan-50 hover:border-cyan-200 transition" data-agent-id="ding-er">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-400 to-cyan-600 flex items-center justify-center flex-shrink-0 relative shadow-md">
                            <i data-lucide="microscope" class="w-5 h-5 text-white"></i>
                            <span class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h4 class="font-medium text-sm truncate">æ£€æµ‹åˆ†æå¸ˆÂ·ä¸äºŒ</h4>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">å¾®æµæ§æ£€æµ‹ Â· ç—…åŸåˆ†æ</p>
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded">åœ¨çº¿</span>
                                <span class="text-xs text-slate-400">ç‚¹å‡»å’¨è¯¢</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æƒ…æŠ¥ä¸“å‘˜Â·ä¸ä¸‰ -->
                <div id="agent-ding3" class="agent-card p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-purple-50 hover:border-purple-200 transition" data-agent-id="ding-san">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center flex-shrink-0 relative shadow-md">
                            <i data-lucide="rss" class="w-5 h-5 text-white"></i>
                            <span class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-white animate-pulse"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <h4 class="font-medium text-sm truncate">æƒ…æŠ¥ä¸“å‘˜Â·ä¸ä¸‰</h4>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">å…¨çƒèµ„è®¯ Â· çƒ­ç‚¹è¿½è¸ª</p>
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded">å®æ—¶</span>
                                <span class="text-xs text-slate-400">ç‚¹å‡»å’¨è¯¢</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç ”æŠ¥åŠ©æ‰‹Â·ä¸å›› -->
                <div id="agent-ding4" class="agent-card p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-amber-50 hover:border-amber-200 transition" data-agent-id="ding-si">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center flex-shrink-0 shadow-md">
                            <i data-lucide="file-text" class="w-5 h-5 text-white"></i>
                            <span class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-sm">ç ”æŠ¥åŠ©æ‰‹Â·ä¸å››</h4>
                            <p class="text-xs text-slate-500 mt-1">è¡Œä¸šç ”æŠ¥ Â· å†³ç­–å»ºè®®</p>
                            <div class="mt-2">
                                <span class="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded">åœ¨çº¿</span>
                                <span class="text-xs text-slate-400">ç‚¹å‡»å’¨è¯¢</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å›¢é˜Ÿç»Ÿè®¡ -->
            <div class="p-4 border-t border-slate-200 bg-slate-50">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="bg-white rounded-lg p-2 border border-slate-200">
                        <p class="text-lg font-semibold text-blue-600" id="apiStatus">â—</p>
                        <p class="text-xs text-slate-500">APIçŠ¶æ€</p>
                    </div>
                    <div class="bg-white rounded-lg p-2 border border-slate-200">
                        <p class="text-lg font-semibold text-green-600" id="msgCount">0</p>
                        <p class="text-xs text-slate-500">å¯¹è¯æ•°</p>
                    </div>
                    <div class="bg-white rounded-lg p-2 border border-slate-200">
                        <p class="text-lg font-semibold text-purple-600">&lt;1s</p>
                        <p class="text-xs text-slate-500">å“åº”æ—¶é—´</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // APIé…ç½®
        // ==========================================
        const API_BASE_URL = 'http://localhost:3001';
        let currentAgentId = 'ding-yi';
        let currentConversationId = 'conv-' + Date.now();
        let isProcessing = false;
        let messageCount = 0;
        
        // Agenté…ç½®
        const agentConfig = {
            'ding-yi': { name: 'ä¸ä¸€', title: 'é‡‡æ ·ä¸“å®¶', icon: 'scan', color: '#3b82f6', bg: 'from-blue-400 to-blue-600' },
            'ding-er': { name: 'ä¸äºŒ', title: 'æ£€æµ‹åˆ†æå¸ˆ', icon: 'microscope', color: '#06b6d4', bg: 'from-cyan-400 to-cyan-600' },
            'ding-san': { name: 'ä¸ä¸‰', title: 'æƒ…æŠ¥ä¸“å‘˜', icon: 'rss', color: '#a855f7', bg: 'from-purple-400 to-purple-600' },
            'ding-si': { name: 'ä¸å››', title: 'ç ”æŠ¥åŠ©æ‰‹', icon: 'file-text', color: '#f59e0b', bg: 'from-amber-400 to-orange-500' }
        };
        
        // ==========================================
        // åˆå§‹åŒ–
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initAgentSelection();
            initChat();
            checkAPIStatus();
            setInterval(checkAPIStatus, 30000);
            
            // é»˜è®¤é€‰ä¸­ä¸ä¸€
            selectAgent('ding-yi');
        });
        
        // ==========================================
        // Agenté€‰æ‹©
        // ==========================================
        function initAgentSelection() {
            document.querySelectorAll('.agent-card').forEach(card => {
                card.addEventListener('click', () => {
                    const agentId = card.dataset.agentId;
                    selectAgent(agentId);
                });
            });
        }
        
        function selectAgent(agentId) {
            if (isProcessing) {
                showToast('è¯·ç­‰å¾…å½“å‰å¯¹è¯å®Œæˆ');
                return;
            }
            
            currentAgentId = agentId;
            const config = agentConfig[agentId];
            
            // æ›´æ–°UIé€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('agent-selected', 'ring-2', 'ring-blue-500');
            });
            const selectedCard = document.querySelector(`[data-agent-id="${agentId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('agent-selected');
            }
            
            // æ›´æ–°é¡¶éƒ¨æŒ‡ç¤ºå™¨
            document.getElementById('currentAgentName').textContent = `${config.name}Â·${config.title}`;
            document.getElementById('currentAgentName').style.color = config.color;
            
            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            addSystemMessage(`å·²åˆ‡æ¢è‡³ ${config.name}ï¼ˆ${config.title}ï¼‰`);
        }
        
        function addSystemMessage(text) {
            const container = document.getElementById('chatContainer');
            const msg = document.createElement('div');
            msg.className = 'flex justify-center my-3';
            msg.innerHTML = `<span class="text-xs text-slate-400 bg-slate-100 px-3 py-1 rounded-full">${text}</span>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }
        
        // ==========================================
        // èŠå¤©åŠŸèƒ½
        // ==========================================
        function initChat() {
            const sendBtn = document.getElementById('sendBtn');
            const chatInput = document.getElementById('chatInput');
            
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
        
        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const text = chatInput.value.trim();
            if (!text || isProcessing) return;
            
            isProcessing = true;
            chatInput.value = '';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addUserMessage(text);
            
            // æ·»åŠ AIæ­£åœ¨è¾“å…¥æç¤º
            const typingId = 'typing-' + Date.now();
            addTypingMessage(typingId);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/agents/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agentId: currentAgentId,
                        message: text,
                        conversationId: currentConversationId
                    })
                });
                
                if (!response.ok) throw new Error(`APIé”™è¯¯: ${response.status}`);
                
                const result = await response.json();
                
                // ç§»é™¤typingæç¤º
                removeTypingMessage(typingId);
                
                if (result.success) {
                    addAIMessage(result.data);
                    messageCount++;
                    document.getElementById('msgCount').textContent = messageCount;
                } else {
                    throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                console.error('Chat error:', error);
                removeTypingMessage(typingId);
                addErrorMessage(error.message);
            } finally {
                isProcessing = false;
            }
        }
        
        function addUserMessage(text) {
            const container = document.getElementById('chatContainer');
            const msg = document.createElement('div');
            msg.className = 'flex gap-3 justify-end animate-slide-in';
            msg.innerHTML = `
                <div class="chat-bubble user rounded-2xl rounded-br-sm px-4 py-3 max-w-lg">
                    <p class="text-sm">${escapeHtml(text)}</p>
                </div>
            `;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }
        
        function addTypingMessage(id) {
            const container = document.getElementById('chatContainer');
            const config = agentConfig[currentAgentId];
            const msg = document.createElement('div');
            msg.id = id;
            msg.className = 'flex gap-3 animate-slide-in';
            msg.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-gradient-to-br ${config.bg} flex items-center justify-center flex-shrink-0">
                    <i data-lucide="${config.icon}" class="w-5 h-5 text-white"></i>
                </div>
                <div class="chat-bubble assistant rounded-2xl rounded-bl-sm px-4 py-3">
                    <p class="text-sm font-medium mb-1" style="color: ${config.color}">${config.name}Â·${config.title}</p>
                    <div class="flex items-center gap-1 h-5">
                        <span class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></span>
                    </div>
                </div>
            `;
            container.appendChild(msg);
            lucide.createIcons();
            container.scrollTop = container.scrollHeight;
        }
        
        function removeTypingMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
        
        function addAIMessage(data) {
            const container = document.getElementById('chatContainer');
            const config = agentConfig[currentAgentId];
            const msg = document.createElement('div');
            msg.className = 'flex gap-3 animate-slide-in';
            msg.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-gradient-to-br ${config.bg} flex items-center justify-center flex-shrink-0">
                    <i data-lucide="${config.icon}" class="w-5 h-5 text-white"></i>
                </div>
                <div class="chat-bubble assistant rounded-2xl rounded-bl-sm px-4 py-3 max-w-xl">
                    <p class="text-sm font-medium mb-2" style="color: ${config.color}">${data.agent.name}Â·${config.title}</p>
                    <div class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${formatContent(data.content)}</div>
                    ${data.metadata ? `
                    <div class="mt-3 flex items-center gap-3 text-xs text-slate-400 border-t border-slate-200 pt-2">
                        <span class="flex items-center gap-1">
                            <i data-lucide="zap" class="w-3 h-3"></i>
                            ${Math.round(data.metadata.latency)}ms
                        </span>
                        <span class="flex items-center gap-1">
                            <i data-lucide="cpu" class="w-3 h-3"></i>
                            ${data.metadata.tokens?.total || 0} tokens
                        </span>
                    </div>
                    ` : ''}
                </div>
            `;
            container.appendChild(msg);
            lucide.createIcons();
            container.scrollTop = container.scrollHeight;
        }
        
        function addErrorMessage(error) {
            const container = document.getElementById('chatContainer');
            const msg = document.createElement('div');
            msg.className = 'flex gap-3 animate-slide-in';
            msg.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-white"></i>
                </div>
                <div class="chat-bubble assistant rounded-2xl rounded-bl-sm px-4 py-3 max-w-xl border-red-200 bg-red-50">
                    <p class="text-sm font-medium mb-1 text-red-600">ç³»ç»Ÿé”™è¯¯</p>
                    <p class="text-sm text-red-500">${escapeHtml(error)}</p>
                    <p class="text-xs text-slate-400 mt-2">è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ (localhost:3001)</p>
                </div>
            `;
            container.appendChild(msg);
            lucide.createIcons();
            container.scrollTop = container.scrollHeight;
        }
        
        // ==========================================
        // å·¥å…·å‡½æ•°
        // ==========================================
        function formatContent(content) {
            // Markdownç®€å•æ ¼å¼åŒ–
            return escapeHtml(content)
                .replace(/\*\*(.+?)\*\*/g, '<strong class="text-slate-900">$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code class="bg-slate-200 px-1.5 py-0.5 rounded text-xs font-mono">$1</code>')
                .replace(/\n/g, '<br>');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-lg text-sm z-50 animate-slide-in';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // ==========================================
        // APIçŠ¶æ€æ£€æŸ¥
        // ==========================================
        async function checkAPIStatus() {
            const statusEl = document.getElementById('apiStatus');
            try {
                const response = await fetch(`${API_BASE_URL}/health`, { method: 'GET' });
                if (response.ok) {
                    statusEl.textContent = 'â—';
                    statusEl.className = 'text-lg font-semibold text-green-600';
                } else {
                    throw new Error('ä¸å¥åº·');
                }
            } catch (error) {
                statusEl.textContent = 'â—';
                statusEl.className = 'text-lg font-semibold text-red-600';
            }
        }
        
        // ==========================================
        // è‡ªåŠ¨æ¢ç´¢æ¨¡å¼ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
        // ==========================================
        const proactiveToggle = document.getElementById('proactiveToggle');
        const proactiveDisplay = document.getElementById('proactiveDisplay');
        const flickeringPrompt = document.getElementById('flickeringPrompt');
        const chatInput = document.getElementById('chatInput');
        let isProactiveMode = false;
        let flickerInterval = null;
        let insightInterval = null;

        const insights = [
            { title: 'éæ´²çŒªç˜Ÿç–«è‹—çªç ´æ€§è¿›å±•', desc: 'ä¸­å›½å†œç§‘é™¢æœ€æ–°ç ”ç©¶ï¼Œä¿æŠ¤ç‡æå‡è‡³85%', type: 'research' },
            { title: 'å¸ƒé²æ°èŒç—…ç›‘æµ‹é¢„è­¦', desc: 'å†…è’™å¤3ä¸ªç›‘æµ‹ç‚¹å‘ç°ç–‘ä¼¼é˜³æ€§æ ·æœ¬', type: 'alert' },
            { title: 'å…¨çƒäººå…½å…±æ‚£ç—…è¶‹åŠ¿', desc: '2025å¹´Q1æŠ¥å‘Šï¼šæ–°å‹ç–«ç—…å¢é•¿12%', type: 'report' },
            { title: 'å†œä¸šå†œæ‘éƒ¨æ–°æ”¿ç­–', desc: 'åŠ¨ç‰©é˜²ç–«æ³•å®æ–½ç»†åˆ™æ­£å¼å®æ–½', type: 'policy' },
            { title: 'å—éä»£è¡¨å›¢è®¿é—®CAAS', desc: 'ç”Ÿç‰©å®‰å…¨ä¸å…¬å…±å«ç”Ÿåˆ›æ–°äº¤æµ', type: 'news' }
        ];

        const prompts = [
            'æ­£åœ¨åˆ†æå…¨çƒäººå…½å…±æ‚£ç—…æœ€æ–°è¶‹åŠ¿...',
            'è¿½è¸ªå†œä¸šå†œæ‘éƒ¨æœ€æ–°æ”¿ç­–åŠ¨æ€...',
            'ç›‘æµ‹å…»æ®–åœºAå®æ—¶æ•°æ®å˜åŒ–...',
            'æŸ¥è¯¢å›½å®¶åŸºå› åº“æœ€æ–°ç ”ç©¶è¿›å±•...',
            'ç”Ÿæˆ2025å¹´Q1è¡Œä¸šç ”æŠ¥...'
        ];

        if (proactiveToggle) {
            proactiveToggle.addEventListener('click', () => {
                isProactiveMode = !isProactiveMode;
                
                if (isProactiveMode) {
                    proactiveToggle.classList.add('bg-blue-500', 'text-white', 'border-blue-600');
                    proactiveToggle.classList.remove('bg-blue-50', 'text-blue-600', 'border-blue-200');
                    proactiveDisplay.classList.remove('hidden');
                    flickeringPrompt.classList.remove('hidden');
                    chatInput.placeholder = '';
                    
                    startFlickering();
                    startInsightRotation();
                } else {
                    proactiveToggle.classList.remove('bg-blue-500', 'text-white', 'border-blue-600');
                    proactiveToggle.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-200');
                    proactiveDisplay.classList.add('hidden');
                    flickeringPrompt.classList.add('hidden');
                    chatInput.placeholder = 'è¾“å…¥ä½ çš„é—®é¢˜ï¼Œæˆ–é€‰æ‹©å³ä¾§Agentä¸“å®¶...';
                    
                    stopFlickering();
                    stopInsightRotation();
                }
            });
        }

        function startFlickering() {
            let index = 0;
            flickerInterval = setInterval(() => {
                index = (index + 1) % prompts.length;
                flickeringPrompt.innerHTML = `<span class="animate-typewriter">${prompts[index]}</span>`;
            }, 30000);
        }

        function stopFlickering() {
            if (flickerInterval) {
                clearInterval(flickerInterval);
                flickerInterval = null;
            }
        }

        function startInsightRotation() {
            const container = document.getElementById('insightCards');
            let index = 0;
            
            showInsight(insights[0]);
            
            insightInterval = setInterval(() => {
                index = (index + 1) % insights.length;
                showInsight(insights[index]);
            }, 30000);
        }

        function stopInsightRotation() {
            if (insightInterval) {
                clearInterval(insightInterval);
                insightInterval = null;
            }
        }

        function showInsight(insight) {
            const container = document.getElementById('insightCards');
            const typeColors = {
                research: 'text-blue-600',
                alert: 'text-red-600',
                report: 'text-purple-600',
                policy: 'text-amber-600',
                news: 'text-cyan-600'
            };
            
            const typeLabels = {
                research: 'ç ”ç©¶',
                alert: 'é¢„è­¦',
                report: 'ç ”æŠ¥',
                policy: 'æ”¿ç­–',
                news: 'èµ„è®¯'
            };
            
            const card = document.createElement('div');
            card.className = 'absolute inset-0 animate-slide-in';
            card.innerHTML = `
                <div class="bg-white rounded-xl p-3 h-full border border-slate-200 shadow-sm flex flex-col justify-center">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs ${typeColors[insight.type]} bg-slate-50 px-2 py-0.5 rounded">${typeLabels[insight.type]}</span>
                        <h4 class="font-medium text-sm ${typeColors[insight.type]}">${insight.title}</h4>
                    </div>
                    <p class="text-xs text-slate-600">${insight.desc}</p>
                    <div class="mt-2 flex items-center gap-2">
                        <button class="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1">
                            æŸ¥çœ‹è¯¦æƒ… <i data-lucide="arrow-right" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
            `;
            
            const oldCards = container.querySelectorAll('.animate-slide-in');
            oldCards.forEach((old, i) => {
                if (i === oldCards.length - 1) old.remove();
            });
            
            container.appendChild(card);
            lucide.createIcons();
        }
    </script>
</body>
</html>
